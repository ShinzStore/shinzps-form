<!DOCTYPE html><html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ShinZ Personal Shopper Order Form</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 600px; margin: auto; background: #f8f9fa; }
    h2, h3 { text-align: center; color: #2c3e50; }
    .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    label { display: block; margin-bottom: 8px; font-weight: 500; }
    .qty-control { display: inline-flex; align-items: center; margin-left: 10px; }
    .qty-control button { width: 30px; height: 30px; margin: 0 5px; background: #f1f1f1; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
    .warning { color: #e74c3c; font-weight: bold; padding: 8px; background: #fdecea; border-radius: 4px; margin: 10px 0; }
    .summary-item { margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; }
    .flex-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .btn { padding: 10px 16px; margin: 5px 0; cursor: pointer; border: none; border-radius: 4px; font-weight: 600; transition: all 0.3s; }
    .btn-primary { background: #3498db; color: white; }
    .btn-primary:hover { background: #2980b9; }
    .btn-secondary { background: #7f8c8d; color: white; }
    .btn-secondary:hover { background: #6c757d; }
    .btn[disabled] { opacity: 0.6; cursor: not-allowed; background: #95a5a6; }
    .info-icon { display: inline-flex; width: 18px; height: 18px; border: 1px solid #3498db; border-radius: 50%; justify-content: center; align-items: center; font-size: 12px; cursor: pointer; margin-left: 6px; color: #3498db; }
    .hidden { display: none; }
    input[type="text"], input[type="tel"], input[type="number"], select { width: 100%; padding: 10px; margin: 6px 0; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; font-size: 15px; }
    input:focus, select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52,152,219,0.2); }
    button.qty-btn { font-size: 16px; }
    .payment-proof { margin-top: 20px; }
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-input-wrapper input[type="file"] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; }
    .file-input-label { display: inline-block; padding: 10px 15px; background: #3498db; color: white; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
    .file-input-label:hover { background: #2980b9; }
    .file-name { margin-left: 10px; color: #555; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-left: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h2>ShinZ Personal Shopper Order Form</h2>
  <div class="section">
    <div class="flex-row">
      <span><strong>MGC-S174 (SOLEHUDDIN)</strong></span>
      <span class="info-icon" onclick="alert('01170351789')">i</span>
    </div>
  </div>
  <div id="section-select" class="section">
    <h3>Pilih Produk</h3>
    <div id="products-container"></div>
    <div id="no-stock-message" class="warning hidden">Sila pilih sekurang-kurangnya satu produk.</div>
    <h3>Pilihan Penghantaran</h3>
    <label><input type="radio" name="ship" value="pos"> Pos (RM10/box)</label>
    <label><input type="radio" name="ship" value="cod"> COD (RM ikut jarak)</label>
    <label><input type="radio" name="ship" value="pickup" checked> Self Pickup</label>
    <div id="shipping-details">
      <label>Nama Penuh: <input type="text" id="customerName" required></label>
      <label>No Telefon: <input type="tel" id="customerPhone" required></label>
      <div id="address-container"></div>
    </div>
    <div id="cod-cost-input" class="hidden"><label>Caj COD: <input type="number" id="codCost" min="0" value="0"></label></div>
    <h3 id="packaging-header" class="hidden">Pembungkusan</h3>
    <div id="packaging-section" class="hidden">
      <label><input type="radio" name="pack" value="3" checked> Basic (RM3)</label>
      <label><input type="radio" name="pack" value="6"> Standard (RM6)</label>
    </div>
    <button id="toReview" class="btn btn-primary">Semak Order</button>
  </div>
  <div id="section-review" class="section hidden">
    <h3>Ringkasan Order</h3>
    <div id="summary"></div>
    <div class="flex-row">Order ID: <span id="orderIdDisplayReview"></span></div>
    <div class="payment-proof">
      <h3>Bukti Pembayaran</h3>
      <div class="file-input-wrapper">
        <label class="file-input-label" for="paymentProof">Muat Naik Fail</label>
        <input type="file" id="paymentProof" accept="image/*" onchange="showFileName(this)">
      </div>
      <span id="fileName" class="file-name"></span>
      <div id="filePreview" class="hidden"><img id="previewImage" style="max-width:100%;max-height:200px"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:20px;">
      <button id="backBtn" class="btn btn-secondary">Kembali</button>
      <button id="confirmBtn" class="btn btn-primary">Sahkan & Hantar <span id="loadingSpinner" class="loading hidden"></span></button>
    </div>
  </div>
  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyMTm4R8grWSBrlyfRpIyHLuIJD5evEKTyVv7WM_7BKQx6djdXJ5up1DzpmAsTLeNJIQQ/exec';
    const products = [ /* ...same products array...*/ ];
    // initProducts, gatherSelected, showSummary same as before// compressImage & showFileName helpers
function compressImage(file, quality=0.7) {
  return new Promise((res,reject)=>{
    const reader=new FileReader(); reader.onload=e=>{
      const img=new Image(); img.onload=()=>{
        const c=document.createElement('canvas');
        const max=1200; let w=img.width,h=img.height;
        if(w>h&&w>max){h*=max/w;w=max;} if(h>w&&h>max){w*=max/h;h=max;}
        c.width=w; c.height=h;
        c.getContext('2d').drawImage(img,0,0,w,h);
        const dataUrl=c.toDataURL(file.type,quality);
        res({name:file.name,mimeType:file.type,data:dataUrl.split(',')[1]});
      }; img.src=e.target.result;}; reader.onerror=reject; reader.readAsDataURL(file);
  });
}

document.addEventListener('DOMContentLoaded',()=>{
  initProducts();
  document.getElementById('toReview').onclick=()=>{/* gather, validate, show */};
  document.getElementById('backBtn').onclick=()=>{/* toggle sections */};
  document.getElementById('confirmBtn').onclick=async()=>{
    const btn=document.getElementById('confirmBtn'); btn.disabled=true;
    const sum=document.getElementById('summary');
    const payload={
      items: gatherSelected().map(i=>`${i.name} x${i.qty}`).join('; '),
      totalPrice:+sum.dataset.totalPrice,
      totalUpah:+sum.dataset.totalUpah,
      totalPackaging:+sum.dataset.totalPack,
      totalShip:+sum.dataset.totalShip,
      totalLogistic:+sum.dataset.totalLogistic,
      grandTotal:+sum.dataset.grandTotal,
      customerName:document.getElementById('customerName').value.trim(),
      customerAddress:(document.getElementById('customerAddressSelect')||{value:''}).value||document.getElementById('customerAddress').value.trim(),
      customerPhone:document.getElementById('customerPhone').value.trim(),
      shippingMethod:document.querySelector('input[name="ship"]:checked').value,
      packaging:(document.querySelector('input[name="pack"]:checked')||{value:''}).value
    };
    const file=document.getElementById('paymentProof').files[0];
    if(!file){alert('Upload bukti pembayaran');btn.disabled=false;return;}        
    payload.paymentProof=await compressImage(file);
    try{
      const res=await fetch(scriptURL,{method:'POST',mode:'cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j=await res.json();
      if(j.success){alert('Order berjaya');location.reload();} else throw new Error(j.message);
    }catch(err){alert('Ralat: '+err.message);btn.disabled=false;}
  };
});

  </script>
</body>
</html>
