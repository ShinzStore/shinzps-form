qtyWrapper.appendChild(plusBtn);
          wrapper.appendChild(qtyWrapper);
        }

        container.appendChild(wrapper);
      });
    }

    function getSelectedProducts() {
      const selected = [];
      products.forEach(prod => {
        const checkbox = document.getElementById("prod-" + prod.code);
        const qtyDisplay = document.getElementById("qty-display-" + prod.code);
        if (checkbox && checkbox.checked && qtyDisplay) {
          const qty = parseInt(qtyDisplay.textContent);
          if (qty > 0) {
            selected.push({
              ...prod,
              qty,
              subtotal: qty * prod.price,
              totalUpah: qty * prod.upah,
              totalLogistic: qty * prod.logistic
            });
          }
        }
      });
      return selected;
    }

    function showShippingInputs() {
      const shipping = document.querySelector('input[name="ship"]:checked').value;
      document.getElementById("shipping-details").classList.toggle("hidden", shipping === "pickup");
      document.getElementById("cod-cost-input").classList.toggle("hidden", shipping !== "cod");
      document.getElementById("packaging-header").classList.toggle("hidden", shipping === "pickup");
      document.getElementById("packaging-section").classList.toggle("hidden", shipping === "pickup");
    }

    function generateSummary() {
      const summaryDiv = document.getElementById("summary");
      const selected = getSelectedProducts();
      if (selected.length === 0) {
        alert("Sila pilih sekurang-kurangnya satu produk.");
        return false;
      }

      const shipping = document.querySelector('input[name="ship"]:checked').value;
      const packaging = document.querySelector('input[name="pack"]:checked')?.value || "0";
      const codCost = shipping === "cod" ? parseFloat(document.getElementById("codCost").value || "0") : 0;

      const nama = document.getElementById("customerName")?.value.trim();
      const alamat = document.getElementById("customerAddress")?.value.trim();
      const telefon = document.getElementById("customerPhone")?.value.trim();

      if (shipping !== "pickup" && (!nama || !alamat || !telefon)) {
        alert("Sila lengkapkan maklumat penghantaran.");
        return false;
      }

      let totalItem = 0, totalUpah = 0, totalLogistic = 0;

      summaryDiv.innerHTML = "";

      selected.forEach(prod => {
        const line = document.createElement("div");
        line.className = "summary-item";
        line.textContent = `${prod.name} x${prod.qty} = RM${prod.subtotal.toFixed(2)}`;
        summaryDiv.appendChild(line);
        totalItem += prod.subtotal;
        totalUpah += prod.totalUpah;
        totalLogistic += prod.totalLogistic;
      });

      const packagingCost = parseFloat(packaging) || 0;
      const totalPackaging = packagingCost;

      const shippingCost = shipping === "pos" ? 10 : (shipping === "cod" ? codCost : 0);
      const grandTotal = totalItem + totalUpah + totalLogistic + totalPackaging + shippingCost;

      summaryDiv.innerHTML += `
        <div class="summary-item">Jumlah Harga Item: RM${totalItem.toFixed(2)}</div>
        <div class="summary-item">Jumlah Upah: RM${totalUpah.toFixed(2)}</div>
        <div class="summary-item">Logistik: RM${totalLogistic.toFixed(2)}</div>
        <div class="summary-item">Pembungkusan: RM${totalPackaging.toFixed(2)}</div>
        <div class="summary-item">Penghantaran: RM${shippingCost.toFixed(2)}</div>
        <hr />
        <div class="summary-item"><strong>Total: RM${grandTotal.toFixed(2)}</strong></div>
      `;

      // Isi ke hidden form
      document.getElementById("field-items").value = selected.map(p => `${p.name} x${p.qty}`).join(", ");
      document.getElementById("field-totalPrice").value = totalItem.toFixed(2);
      document.getElementById("field-totalUpah").value = totalUpah.toFixed(2);
      document.getElementById("field-totalPackaging").value = totalPackaging.toFixed(2);
      document.getElementById("field-totalShip").value = shippingCost.toFixed(2);
      document.getElementById("field-totalLogistic").value = totalLogistic.toFixed(2);
      document.getElementById("field-grandTotal").value = grandTotal.toFixed(2);
      document.getElementById("field-customerName").value = nama || "-";
      document.getElementById("field-customerAddress").value = alamat || "-";
      document.getElementById("field-customerPhone").value = telefon || "-";

      return true;
    }

    // Event Listeners
    document.querySelectorAll('input[name="ship"]').forEach(radio => {
      radio.addEventListener("change", showShippingInputs);
    });

    document.getElementById("toReview").addEventListener("click", () => {
      if (generateSummary()) {
        document.getElementById("section-select").classList.add("hidden");
        document.getElementById("section-review").classList.remove("hidden");
        document.getElementById("orderIdDisplayReview").textContent = "AUTO-" + Date.now();
      }
    });

    document.getElementById("backBtn").addEventListener("click", () => {
      document.getElementById("section-review").classList.add("hidden");
      document.getElementById("section-select").classList.remove("hidden");
    });

    document.getElementById("confirmBtn").addEventListener("click", () => {
      alert("Pesanan anda sedang dihantar. Anda akan dibawa ke borang Google untuk muat naik resit.");
      document.getElementById("hiddenForm").submit();
    });

    window.addEventListener("load", () => {
      initProducts();
      showShippingInputs();
    });
  </script>
</body>
</html>
